
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../htwg-thumbnail-textelement/htwg-thumbnail-textelement.html">
<link rel="import" href="../htwg-tagelement/htwg-tagelement.html">
<link rel="import" href="../../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<dom-module id="htwg-thumbnail-tagfilter">

  <template>

    <style type="text/css">
      .wrapper{
        display: inline-block;

      }
    </style>

    <div class=wrapper>
      <div id="textfieldtagfilter" class="tagfilter" >
        <input pattern="[a-z]" on-keyup="keyup" on-input="validateInput" id="taginput"></input>
        <!--<htwg-tagelement text="girls"></htwg-tagelement>-->
      </div>
  </div>

    
  </template>
</dom-module>

<script>
  Polymer({
    is: 'htwg-thumbnail-tagfilter',
    behaviors: [
      Polymer.IronA11yKeysBehavior
    ],

    properties: {
      textColor: {
        type: String,
        value: "black"
      },
      textSize: { 
        type: Number,
        value: 10
      },
      textFamily:{
        type: String,
        value: "Arial"
      },
      savedTag: {
        type: Array,
        value: [],
        observer: '_savedTagDeleted'
      },
      tagList: {
        type: Array,
        value: []
      },
    },
    validateInput: function(event){
        var inputValue = this.$.taginput.value;
        var inputChar = inputValue.substring(inputValue.length-1, inputValue.length);
        if(!inputChar.match("[a-z]")){
          var newString = inputValue.substring(0,inputValue.length-1);
          this.$.taginput.value = newString;
        }
    },

    keyup: function(event){
      const enterKey = 13;
      var inputVal = this.$.taginput.value;
      var valid = false;

      if(event.keyCode === enterKey){
        for(i = 0 ; i < this.tagList.length; i++){
          for(ii = 0; ii < this.tagList[i].length;ii++){
            if(this.tagList[i][ii] == inputVal){
              if (this.savedTag.indexOf(inputVal) == -1) {
                this.savedTag.push(inputVal);
              }
              valid = true;
			  break;
            }
          }
        }
        if (!valid){
          alert("Not a valid tag!");
        } else {
			this.markTag();
		}
		this.$.taginput.value = "";
      }
      
    },
    markTag: function(create=0){
      var listElements = document.getElementsByTagName("htwg-thumbnail-textelement");
	  //not nice but a temporary bug fix
	  for(i = 0; i < listElements.length; i++){
		listElements[i].parentElement.marked = false;
	  }
      for(i = 0; i < listElements.length; i++){
          tmpcounter = 0;
          listElements[i].active = false;
          for(ii = 0; ii < listElements[i].tags.length; ii++){
            var tag = listElements[i].tags[ii]; 
            if(this.savedTag.indexOf(tag) != -1){
				console.log(tag);
              tmpcounter++;
            }
          }
          if (tmpcounter == this.savedTag.length && tmpcounter != 0){
            listElements[i].active = true;
            listElements[i].parentElement.marked = true;
          }
      }
      if (create == 0) {
        var tagelement = document.createElement('htwg-tagelement');
        this.$.textfieldtagfilter.appendChild(tagelement);
        tagelement.text = this.$.taginput.value;
      }

    },
    attached:function(){
      var listElements = document.getElementsByTagName("htwg-thumbnail-textelement");
      for(i = 0; i < listElements.length; i++){
          this.tagList.push(listElements[i].tags);
      }
      console.log(this.tagList);
    },
    _savedTagDeleted: function(){
      //alert("deleted");
    },
    deleteTag: function(obj){
      this.savedTag.splice(this.savedTag.indexOf(obj.text,1));
      this.markTag(-1);
      obj.remove();
    }

  });
</script>